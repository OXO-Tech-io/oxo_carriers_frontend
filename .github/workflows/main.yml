name: Deploy to cPanel

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy to cPanel
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Create deployment package
        run: |
          mkdir -p deploy
          
          # If standalone build exists, use it
          if [ -d ".next/standalone" ]; then
            echo "Using standalone build..."
            # Create .next directory first
            mkdir -p deploy/.next
            # Copy standalone build contents
            cp -r .next/standalone/* deploy/
            # Copy static files
            if [ -d ".next/static" ]; then
              cp -r .next/static deploy/.next/static
            fi
            # Copy public directory if it doesn't exist in standalone
            if [ ! -d "deploy/public" ] && [ -d "public" ]; then
              cp -r public deploy/public
            fi
          else
            echo "Using standard build..."
            # Copy build output
            mkdir -p deploy/.next
            if [ -d ".next/static" ]; then
              cp -r .next/static deploy/.next/static
            fi
            if [ -d ".next/server" ]; then
              cp -r .next/server deploy/.next/server
            fi
            if [ -d ".next/cache" ]; then
              cp -r .next/cache deploy/.next/cache
            fi
            
            # Copy source files
            cp -r app deploy/app
            cp -r components deploy/components
            cp -r lib deploy/lib
            cp -r hooks deploy/hooks
            cp -r store deploy/store
            cp -r types deploy/types
            cp -r public deploy/public
            
            # Copy config files
            cp package.json deploy/
            cp package-lock.json deploy/
            cp next.config.ts deploy/
            cp tsconfig.json deploy/
            cp postcss.config.mjs deploy/ 2>/dev/null || true
          fi
          
          # Create .htaccess for Next.js routing (if using Apache)
          cat > deploy/.htaccess << 'EOF'
          RewriteEngine On
          RewriteBase /
          
          # Handle Next.js routes
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule ^(.*)$ /index.html [L]
          
          # Security headers
          <IfModule mod_headers.c>
            Header set X-Content-Type-Options "nosniff"
            Header set X-Frame-Options "DENY"
            Header set X-XSS-Protection "1; mode=block"
          </IfModule>
          EOF
          
          # Create package.json for production if using standalone
          if [ -d ".next/standalone" ]; then
            echo "Standalone build ready for deployment"
          fi

      - name: Deploy to cPanel via SFTP
        timeout-minutes: 600
        continue-on-error: false
        uses: milanmk/actions-file-deployer@master
        with:
          remote-protocol: "sftp"
          remote-host: ${{ secrets.SFTP_HOST || secrets.FTP_SERVER }}
          remote-user: ${{ secrets.SFTP_USERNAME || secrets.FTP_USERNAME }}
          remote-password: ${{ secrets.SFTP_PASSWORD || secrets.FTP_PASSWORD }}
          remote-port: ${{ secrets.SFTP_PORT || 22 }}
          remote-path: ${{ secrets.DEPLOY_PATH || '/public_html/' }}
          ssh-private-key: ${{ secrets.SFTP_KEY }}
          delta-file-sync: true
          mirror: false
          exclude: |
            **/.git*
            **/node_modules
            **/.next/cache
            **/.env.local
            **/.env.development
            **/.env.test
            **/README.md
            **/.gitignore
            **/tsconfig.json
            **/eslint.config.mjs
            **/next-env.d.ts
            **/src_backup

      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üì¶ Application deployed to: ${{ secrets.DEPLOY_PATH || '/public_html/' }}"
          echo "üåê Your Next.js app should be live now!"
